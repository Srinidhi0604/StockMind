<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>StockMind AI - Equity Clustering</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>

<body>
  {% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
  <div class="flash-messages-container">
    {% for category, message in messages %}
    <div class="flash-message flash-{{ category }}">
      {{ message }}
      <button type="button" class="flash-close-btn" onclick="this.parentElement.style.display='none'">&times;</button>
    </div>
    {% endfor %}
  </div>
  {% endif %}
  {% endwith %}

  <header class="site-header">
    <div class="container header-content">
      <div class="logo-tagline">
        <div class="logo">StockMind</div>
        <div class="tagline">AI-Driven Equity Analysis</div>
      </div>
      <nav class="auth-section">
        {% if session.get('username') %}
        <span class="welcome-msg">Welcome, {{ session.get('username') }}!</span>
        <a class="header-btn logout-btn" href="{{url_for('auth.logout')}}">
          Logout
        </a>
        {% else %}
        <a class="header-btn login-btn" href="{{url_for('auth.accessAccount')}}"> Login
        </a>
        {% endif %}
      </nav>
    </div>
  </header>

  <main class="main-content">
    <section class="hero">
      <div class="container hero-content">
        <h1>AI-Driven Equity Clustering</h1>
        <p>Identify comparable peer companies using Large Language Models (LLMs) for precise equity valuation.</p>
      </div>
    </section>

    <section id="input" class="input-section">
      <div class="container">
        
        <form id="company-form">
          <div class="form-group">
            <input type="text" id="companyName" placeholder="Enter Company Name (e.g., Apple Inc.)" required>
            <button type="submit" class="cta-button">Analyze</button>
          </div>
          <p id="loading" class="loading-indicator" style="display: none;">
            <span class="spinner"></span>Processing... Please wait.
          </p>
        </form>
      </div>
    </section>

    <section id="results" class="section-container results-section" style="display: none;">
      <div class="container">
        <h2>Analysis Results</h2>

        <div id="descriptionSection" class="result-card" style="display: none;">
          <h3><i class="fas fa-building"></i> Company Description</h3>
          <div class="content" id="description"></div>
        </div>

        <div class="grid-container">
            <div id="tickerSection" class="result-card" style="display: none;">
              <h3><i class="fas fa-hashtag"></i> Ticker</h3>
              <div class="content" id="ticker"></div>
            </div>

            <div id="stockPriceSection" class="result-card" style="display: none;">
              <h3><i class="fas fa-dollar-sign"></i> Current Stock Price</h3>
              <div class="content" id="stock-price"></div>
            </div>
        </div>

        <div id="graphSection" class="result-card chart-card" style="display: none;">
          <h3><i class="fas fa-chart-line"></i> Stock Price History</h3>
          <canvas id="stockGraph"></canvas>
        </div>

        <div id="competitorsSection" class="result-card" style="display: none;">
          <h3><i class="fas fa-users"></i> Peer Competitors</h3>
          <pre id="competitorsList" class="content"></pre>
        </div>

        <div id="topCompetitorsSection" class="result-card" style="display: none;">
          <h3><i class="fas fa-trophy"></i> Top 3 Peer Competitors by Market Evaluation</h3>
          <div id="topCompetitorsList" class="content top-competitors-grid"></div>
          <div class="chart-card">
            <h4><i class="fas fa-chart-area"></i> Combined Stock Price Graph for Top 3</h4>
            <canvas id="topCompetitorsGraph"></canvas>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer class="site-footer-bottom">
    <div class="container">
      <p>&copy; <span id="currentYear"></span> StockMind AI. All Rights Reserved.</p>
      <div class="social-icons">
        <a href="#" aria-label="Facebook"><i class="fab fa-facebook-f"></i></a>
        <a href="#" aria-label="Twitter"><i class="fab fa-twitter"></i></a>
        <a href="#" aria-label="LinkedIn"><i class="fab fa-linkedin-in"></i></a>
      </div>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    document.getElementById('currentYear').textContent = new Date().getFullYear();

    const companyForm = document.getElementById('company-form');
    const loadingText = document.getElementById('loading');
    const resultsSection = document.getElementById('results');
    const descriptionSection = document.getElementById('descriptionSection');
    const tickerSection = document.getElementById('tickerSection');
    const stockPriceSection = document.getElementById('stockPriceSection');
    const graphSection = document.getElementById('graphSection');
    const competitorsSection = document.getElementById('competitorsSection');
    const topCompetitorsSection = document.getElementById('topCompetitorsSection');

    let stockChartInstance = null;
    let topCompetitorsChartInstance = null;

    // Function to animate section reveal
    function revealSection(sectionElement) {
        sectionElement.style.display = 'block';
        // Wait for the display property to apply, then add class for animation
        setTimeout(() => {
            sectionElement.classList.add('visible');
        }, 50); // A small delay
    }


    companyForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const companyName = document.getElementById('companyName').value.trim();
      if (!companyName) {
        // You could implement a custom alert/modal here for better UX
        alert('Please enter a company name!');
        return;
      }

      loadingText.style.display = 'flex'; // Changed to flex for spinner alignment
      resultsSection.style.display = 'none'; // Hide previous results
      // Remove 'visible' class from all result cards for re-animation
      document.querySelectorAll('.result-card, .results-section').forEach(el => el.classList.remove('visible'));


      try {
        const apiUrl = window.location.origin;
        const response = await fetch(`${apiUrl}/service/analyze_company?company_name=${encodeURIComponent(companyName)}`);
        const data = await response.json();

        if (data.success) {
          revealSection(resultsSection);

          document.getElementById('description').textContent = data.description;
          revealSection(descriptionSection);

          document.getElementById('ticker').textContent = data.ticker;
          revealSection(tickerSection);
          
          document.getElementById('stock-price').textContent = `$${parseFloat(data.stock_prices[data.stock_prices.length - 1]).toFixed(2)}`;
          revealSection(stockPriceSection);
          
          renderGraph(data.stock_prices, data.time_labels);
          revealSection(graphSection);

          const competitorsListEl = document.getElementById('competitorsList');
          competitorsListEl.textContent = ''; // Clear previous
          if (data.competitors && data.competitors.length > 0) {
            data.competitors.forEach((sector) => {
              competitorsListEl.textContent += `${sector.name.toUpperCase()}\n`;
              sector.competitors.forEach((competitor) => {
                competitorsListEl.textContent += `  â€¢ ${competitor}\n`;
              });
              competitorsListEl.textContent += `\n`;
            });
            revealSection(competitorsSection);
          } else {
            competitorsSection.style.display = 'none';
          }


          if (data.top_competitors && data.top_competitors.length > 0) {
            const topCompetitorsListEl = document.getElementById('topCompetitorsList');
            topCompetitorsListEl.innerHTML = ''; // Clear previous

            data.top_competitors.forEach((comp) => {
              const compCard = document.createElement('div');
              compCard.className = 'competitor-item';
              compCard.innerHTML = `
                <h4>${comp.name}</h4>
                <p>Stock Price: $${parseFloat(comp.stock_price).toFixed(2)}</p>
              `;
              topCompetitorsListEl.appendChild(compCard);
            });
            renderTopCompetitorsGraph(data.top_competitors);
            revealSection(topCompetitorsSection);

          } else {
            topCompetitorsSection.style.display = 'none';
          }

        } else {
          // Implement a more user-friendly error display
          alert(data.error || 'Error fetching data. Please try again.');
          resultsSection.style.display = 'none';
        }
      } catch (error) {
        console.error('Error:', error);
        alert('An unexpected error occurred. Please check the console and try again.');
        resultsSection.style.display = 'none';
      } finally {
        loadingText.style.display = 'none';
      }
    });

    const chartDefaultOptions = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { 
                position: 'top',
                labels: {
                    color: '#A1A1AA',
                    font: {
                        family: "'Poppins', sans-serif",
                        size: 13,
                        weight: '500'
                    },
                    padding: 20,
                    usePointStyle: true,
                    pointStyle: 'circle'
                }
            },
            tooltip: {
                backgroundColor: 'rgba(17, 17, 17, 0.95)',
                titleFont: {
                    family: "'Poppins', sans-serif",
                    size: 14,
                    weight: '600'
                },
                bodyFont: {
                    family: "'Poppins', sans-serif",
                    size: 13
                },
                padding: 12,
                cornerRadius: 8,
                displayColors: true,
                borderColor: 'rgba(255, 255, 255, 0.1)',
                borderWidth: 1,
                callbacks: {
                    label: function(context) {
                        let label = context.dataset.label || '';
                        if (label) {
                            label += ': ';
                        }
                        if (context.parsed.y !== null) {
                            label += new Intl.NumberFormat('en-US', { 
                                style: 'currency', 
                                currency: 'USD',
                                minimumFractionDigits: 2,
                                maximumFractionDigits: 2
                            }).format(context.parsed.y);
                        }
                        return label;
                    }
                },
                animation: {
                    duration: 200
                }
            }
        },
        interaction: {
            intersect: false,
            mode: 'index'
        },
        animation: {
            duration: 1500,
            easing: 'easeInOutQuart',
            onProgress: function(animation) {
                const progress = animation.currentStep / animation.numSteps;
                const ctx = animation.chart.ctx;
                const chartArea = animation.chart.chartArea;
                
                // Add subtle gradient animation during chart load
                const gradient = ctx.createLinearGradient(0, chartArea.bottom, 0, chartArea.top);
                gradient.addColorStop(0, 'rgba(99, 102, 241, 0.1)');
                gradient.addColorStop(progress, 'rgba(99, 102, 241, 0.2)');
                gradient.addColorStop(1, 'rgba(99, 102, 241, 0.1)');
                
                ctx.fillStyle = gradient;
                ctx.fillRect(chartArea.left, chartArea.top, chartArea.right - chartArea.left, chartArea.bottom - chartArea.top);
            }
        },
        scales: {
            x: {
                grid: {
                    color: 'rgba(255, 255, 255, 0.05)',
                    drawBorder: false,
                    drawTicks: false
                },
                ticks: {
                    color: '#A1A1AA',
                    font: {
                        family: "'Poppins', sans-serif",
                        size: 12
                    },
                    maxRotation: 45,
                    minRotation: 45,
                    padding: 10
                }
            },
            y: {
                grid: {
                    color: 'rgba(255, 255, 255, 0.05)',
                    drawBorder: false,
                    drawTicks: false
                },
                ticks: {
                    color: '#A1A1AA',
                    font: {
                        family: "'Poppins', sans-serif",
                        size: 12
                    },
                    padding: 10,
                    callback: function(value) {
                        return new Intl.NumberFormat('en-US', { 
                            style: 'currency', 
                            currency: 'USD', 
                            minimumFractionDigits: 0, 
                            maximumFractionDigits: 0 
                        }).format(value);
                    }
                }
            }
        },
        elements: {
            line: {
                tension: 0.4
            },
            point: {
                radius: 0,
                hitRadius: 10,
                hoverRadius: 6,
                hoverBorderWidth: 2
            }
        }
    };

    function renderGraph(stockPrices, timeLabels) {
        const ctx = document.getElementById('stockGraph').getContext('2d');
        
        // Destroy existing chart if it exists
        if (stockChartInstance) {
            stockChartInstance.destroy();
        }
        
        // Create gradient for the line
        const gradient = ctx.createLinearGradient(0, 0, 0, 400);
        gradient.addColorStop(0, 'rgba(99, 102, 241, 0.2)');
        gradient.addColorStop(1, 'rgba(99, 102, 241, 0)');
        
        stockChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: timeLabels,
                datasets: [{
                    label: 'Stock Price',
                    data: stockPrices,
                    borderColor: '#6366F1',
                    backgroundColor: gradient,
                    borderWidth: 2,
                    pointRadius: 0,
                    pointHoverRadius: 6,
                    pointHoverBackgroundColor: '#6366F1',
                    pointHoverBorderColor: '#FFFFFF',
                    pointHoverBorderWidth: 2,
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                ...chartDefaultOptions,
                plugins: {
                    ...chartDefaultOptions.plugins,
                    legend: {
                        display: false
                    }
                }
            }
        });
    }

    function renderTopCompetitorsGraph(competitors) {
        const ctx = document.getElementById('topCompetitorsGraph').getContext('2d');
        
        // Destroy existing chart if it exists
        if (topCompetitorsChartInstance) {
            topCompetitorsChartInstance.destroy();
        }
        
        const colors = [
            { border: '#6366F1', background: 'rgba(99, 102, 241, 0.1)' },  // Indigo
            { border: '#10B981', background: 'rgba(16, 185, 129, 0.1)' },  // Emerald
            { border: '#F59E0B', background: 'rgba(245, 158, 11, 0.1)' }   // Amber
        ];
        
        const datasets = competitors.map((comp, index) => {
            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, colors[index].background);
            gradient.addColorStop(1, 'rgba(0, 0, 0, 0)');
            
            return {
                label: comp.name,
                data: comp.stock_prices,
                borderColor: colors[index].border,
                backgroundColor: gradient,
                borderWidth: 2,
                pointRadius: 0,
                pointHoverRadius: 6,
                pointHoverBackgroundColor: colors[index].border,
                pointHoverBorderColor: '#FFFFFF',
                pointHoverBorderWidth: 2,
                tension: 0.4,
                fill: true
            };
        });
        
        topCompetitorsChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: competitors[0].time_labels,
                datasets: datasets
            },
            options: chartDefaultOptions
        });
    }
  </script>
</body>
</html>
